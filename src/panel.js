// Load WASM
WebAssembly.instantiateStreaming(
    fetch("data:application/wasm;base64,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AkAgAEF8Sw0AAkAgAA0AQQQPCyAAIABBfUlBAnQQBCIARQ0AIAAPCwALDgACQCABRQ0AIAAQAQsLCwAgACMAaiQAIwALBAAgAAsCAAsLkYCAgAABAEGAgMAACwgEAAAAAAAAAADmhICAAARuYW1lAduEgIAADwA6ZGxtYWxsb2M6OmRsbWFsbG9jOjpEbG1hbGxvYzxBPjo6bWFsbG9jOjpoZWViNjkzYzcyM2Q3N2ZhMAE4ZGxtYWxsb2M6OmRsbWFsbG9jOjpEbG1hbGxvYzxBPjo6ZnJlZTo6aGIwN2VlZmQzMWVhY2Q4NGMCDl9fcnVzdF9yZWFsbG9jA0FkbG1hbGxvYzo6ZGxtYWxsb2M6OkRsbWFsbG9jPEE+OjpkaXNwb3NlX2NodW5rOjpoM2VlODExYjMyZTMzZGRiNAQwZGxtYWxsb2M6OkRsbWFsbG9jPEE+OjptYWxsb2M6OmhiZDJiMmE1NjFlMGVmNjcwBUZkbG1hbGxvYzo6ZGxtYWxsb2M6OkRsbWFsbG9jPEE+OjppbnNlcnRfbGFyZ2VfY2h1bms6OmgyZDdhYjRjZDIxYjliMWU4BkZkbG1hbGxvYzo6ZGxtYWxsb2M6OkRsbWFsbG9jPEE+Ojp1bmxpbmtfbGFyZ2VfY2h1bms6OmhiMDc5MjVmMDMyY2M4NjQ4BwZtZW1jcHkIOWFsbG9jOjp2ZWM6OlZlYzxULEE+OjppbnRvX2JveGVkX3NsaWNlOjpoMzFmMjNiYzk2MTBlYWU0YwkGZGVjb2RlChFfX3diaW5kZ2VuX21hbGxvYwsPX193YmluZGdlbl9mcmVlDB9fX3diaW5kZ2VuX2FkZF90b19zdGFja19wb2ludGVyDQR0ZXh0DjdzdGQ6OmFsbG9jOjpkZWZhdWx0X2FsbG9jX2Vycm9yX2hvb2s6OmhjODU0MWY3YzFlYzMyYWZlAO+AgIAACXByb2R1Y2VycwIIbGFuZ3VhZ2UBBFJ1c3QADHByb2Nlc3NlZC1ieQMFcnVzdGMdMS41Ni4xICg1OWVlZDhhMmEgMjAyMS0xMS0wMSkGd2FscnVzBjAuMTkuMAx3YXNtLWJpbmRnZW4GMC4yLjc4")
)
    .then(obj => obj.instance.exports)
    .then(initialize);

function initialize(candid) {
    console.log(candid, "test", candid.text(13));

    const log = [];

    // Start capture
    chrome.devtools.network.onRequestFinished.addListener((request) => capture(candid, log, request));
};

// Decode and log Dfinity CBOR/Candid network events.
function capture(candid, log, request) {

    // Look for a cbor content type header.
    const isCBOR = request.response.headers
        .find(x => x.name === 'content-type')
        ?.value === 'application/cbor';

    function decode(value) {
        // TODO
        // return candid.decode(value);
        return "CANDID VALUE";
    };

    if (isCBOR) {
        request.getContent((content, encoding) => {

            if (encoding !== 'base64') {
                // Janky AF, but AFAIK all IC responses are b64 encoded.
                return
            };

            // Assumption from here is that this is an IC request.

            // Chrome gives us the request body decoded into utf8?
            // It's busted, so we reencode it.
            const requestB64 = btoa(request?.request?.postData?.text);

            // Decode request.
            const requestBytes = _base64ToBytes(requestB64);
            const requestCBOR = CBOR.decode(requestBytes.buffer);
            // const requestHex = toHexString(requestBytes);

            // Decode response.
            const responseBytes = _base64ToBytes(content);
            const responseCBOR = CBOR.decode(responseBytes.buffer);
            // const responseHex = toHexString(responseBytes);

            // Find candid values.
            // Assumption: all candid values are Uint8Array and all Uint8Array values are candid.
            function findCandid(object) {
                let candidFields = {};
                for (let [key, value] of Object.entries(object)) {
                    // Capture and decode Uint8Arrays.
                    if (value instanceof Uint8Array) {
                        candidFields[key] = decode(Uint8Array.from(value));
                        // Recurse downward.
                    } else if (typeof value === 'object') {
                        candidFields[key] = findCandid(value);
                    };
                };
                return candidFields;
            };

            const requestCandid = findCandid(requestCBOR);
            const responseCandid = findCandid(responseCBOR);

            const decodedRequest = mergeDeep({}, requestCBOR, requestCandid);
            const decodedResponse = mergeDeep({}, responseCBOR, responseCandid);

            // console.log(requestCandid, requestCBOR, decodedRequest);

            log.push({
                url: request.request.url,
                request: decodedRequest,
                response: decodedResponse,
            });

            document.getElementById('log').innerHTML = renderLog(log);

        });
    };
}

// Render decoded logs
const renderLog = (log) => `${log.map(entry => `
    <div>
        <div><strong>URL: </strong>${entry.url}</div>
        <div><strong>Request: </strong>${JSON.stringify(entry.request, undefined, 4)}</div>
        <div><strong>Response: </strong>${JSON.stringify(entry.response, undefined, 4)}</div>
    </div>
`).join('<hr />')}`;

// Converting things...
function _base64ToBytes(base64) {
    var binary_string = window.atob(base64);
    var len = binary_string.length;
    var bytes = new Uint8Array(len);
    for (var i = 0; i < len; i++) {
        bytes[i] = binary_string.charCodeAt(i);
    }
    return bytes;
}

function toHexString(byteArray) {
    return Array.from(byteArray).map(x => {
        return byteToHex(x);
    }).join(' ');
}

var hexChar = ["0", "1", "2", "3", "4", "5", "6", "7", "8", "9", "A", "B", "C", "D", "E", "F"];

function byteToHex(b) {
    return hexChar[(b >> 4) & 0x0f] + hexChar[b & 0x0f];
}

/**
 * Simple object check.
 * @param item
 * @returns {boolean}
 */
function isObject(item) {
    return (item && typeof item === 'object');
}

/**
 * Deep merge two objects.
 * @param target
 * @param ...sources
 */
function mergeDeep(target, ...sources) {
    if (!sources.length) return target;
    const source = sources.shift();

    if (isObject(target) && isObject(source)) {
        for (const key in source) {
            if (isObject(source[key])) {
                if (!target[key]) Object.assign(target, { [key]: {} });
                mergeDeep(target[key], source[key]);
            } else {
                Object.assign(target, { [key]: source[key] });
            }
        }
    }

    return mergeDeep(target, ...sources);
}